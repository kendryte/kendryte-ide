"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const stream_1 = require("stream");
const include_1 = require("./include");
function ThrowStatusCodeError(status, signal) {
    const e = StatusCodeError(status, signal);
    if (e) {
        throw e;
    }
    return;
}
function chdir(d) {
    process.chdir(d);
    console.log('\n > %s', process.cwd());
}
exports.chdir = chdir;
function StatusCodeError(status, signal) {
    if (status === 0 && !signal) {
        return null;
    }
    return new Error(signal ? `Program exit by signal "${signal}"` : `Program exit with code "${status}"`);
}
function parseCommand(cmd, args) {
    if (include_1.isWin) {
        return ['powershell.exe', ['-Command', cmd, ...args]];
    }
    else {
        return [cmd, args];
    }
}
function shellSync(stdio, cmd, args) {
    const r = child_process_1.spawnSync(cmd, args, {
        stdio,
        encoding: 'utf8',
    });
    if (r.error) {
        throw r.error;
    }
    ThrowStatusCodeError(r.status, r.signal);
    return r;
}
function shellExec(cmd, ...args) {
    [cmd, args] = parseCommand(cmd, args);
    console.log(' + %s %s | pipe-output', cmd, args.join(' '));
    shellSync('inherit', cmd, args);
}
exports.shellExec = shellExec;
function shellMute(cmd, ...args) {
    [cmd, args] = parseCommand(cmd, args);
    console.log(' + %s %s | mute-output', cmd, args.join(' '));
    shellSync(['ignore', 'ignore', 'inherit'], cmd, args);
}
exports.shellMute = shellMute;
function shellOutput(cmd, ...args) {
    [cmd, args] = parseCommand(cmd, args);
    console.log(' + %s %s | read-output', cmd, args.join(' '));
    const r = shellSync(['ignore', 'pipe', 'inherit'], cmd, args);
    return r.stdout;
}
exports.shellOutput = shellOutput;
async function pipeCommandOut(pipe, cmd, ...args) {
    [cmd, args] = parseCommand(cmd, args);
    console.log(' + %s %s | line-output', cmd, args.join(' '));
    const cp = child_process_1.spawn(cmd, args, {
        stdio: ['ignore', 'pipe', 'inherit'],
    });
    cp.stdout.pipe(pipe, { end: false });
    await promiseProcess(cp);
}
exports.pipeCommandOut = pipeCommandOut;
class PassThru extends stream_1.Transform {
    _transform(chunk, encoding, callback) {
        this.push(chunk, encoding);
        callback();
    }
}
function outputCommand(cmd, ...args) {
    [cmd, args] = parseCommand(cmd, args);
    console.log(' + %s %s | stream-output', cmd, args.join(' '));
    const output = new PassThru();
    return {
        output,
        wait() {
            const cp = child_process_1.spawn(cmd, args, {
                stdio: ['ignore', output, output],
            });
            return promiseProcess(cp);
        },
    };
}
exports.outputCommand = outputCommand;
function promiseProcess(cp) {
    return new Promise((resolve, reject) => {
        cp.once('error', reject);
        cp.once('exit', (code, signal) => {
            const e = StatusCodeError(code, signal);
            if (e) {
                reject(e);
            }
            else {
                resolve();
            }
        });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpbGRDb21tYW5kcy5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsiYnVpbGQtZW52L2NoaWxkQ29tbWFuZHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpREFBNkU7QUFDN0UsbUNBQXVEO0FBQ3ZELHVDQUFrQztBQUVsQyxTQUFTLG9CQUFvQixDQUFDLE1BQWMsRUFBRSxNQUFjO0lBQzNELE1BQU0sQ0FBQyxHQUFHLGVBQWUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDMUMsSUFBSSxDQUFDLEVBQUU7UUFDTixNQUFNLENBQUMsQ0FBQztLQUNSO0lBQ0QsT0FBTztBQUNSLENBQUM7QUFFRCxTQUFnQixLQUFLLENBQUMsQ0FBUztJQUM5QixPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZDLENBQUM7QUFIRCxzQkFHQztBQUVELFNBQVMsZUFBZSxDQUFDLE1BQWMsRUFBRSxNQUFjO0lBQ3RELElBQUksTUFBTSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtRQUM1QixPQUFPLElBQUksQ0FBQztLQUNaO0lBQ0QsT0FBTyxJQUFJLEtBQUssQ0FDZixNQUFNLENBQUEsQ0FBQyxDQUFDLDJCQUEyQixNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsMkJBQTJCLE1BQU0sR0FBRyxDQUNuRixDQUFDO0FBQ0gsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLEdBQVcsRUFBRSxJQUFjO0lBQ2hELElBQUksZUFBSyxFQUFFO1FBQ1YsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7S0FDdEQ7U0FBTTtRQUNOLE9BQU8sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDbkI7QUFDRixDQUFDO0FB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